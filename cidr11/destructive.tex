\begin{comment}
\jmh{Alternative to lines 5--9 is to insert the following rule.  It ``preserves'' the action items that have adds but no deletes ... i.e. the other branch of the left-outer-join.  I think this is easier to explain.}  \jmh{regardless of what you decide, be sure to explain all lines of the program!}
\begin{scriptsize}
\begin{verbatim}
	status <= join(action_cnt, checkout).map do |a, c|
	  if a.action == "Add" and not
	        action_cnt.map{|d| d.id if d.action == "Del" and a.id}.include? a.id
	     [a.session, a.item, a.cnt]
	  end
	end
\end{verbatim}	
\end{scriptsize}
\end{comment}

\begin{figure}[t]
\begin{scriptsize}
\begin{verbatim}
0:   declare
1:   def store
2:     kvput <= action_msg.map do |a|
3:       if not bigtable.map{|b| b.key}.include? a.session
4:         if a.action == "Add"
5:           [a.server, a.client, a.session, a.reqid, [a.item]]
6:         elsif a.action == "Del"
7:           [a.server, a.client, a.session, a.reqid, []]
8:         end
9:       end
10:    end  
11:
12:    kvput <= join([bigtable, action_msg]).map do |b, a|
13:      if b.key == a.session
14:        if a.action == "Add"
15:          [a.server, a.client, a.session, 
16:           a.reqid, b.value.push(a.item)]
17:        elsif a.action == "Del"
18:          [a.server, a.client, a.session, 
19:           a.reqid, b.value.reject{|bv| bv == a.item}]
20:        end
21:      end
22:    end
23:  end
24:
25:  declare
26:  def communicate
27:    action_msg <+ client_action.map{|a| a}
28:
29:    response_msg <+ join([bigtable, checkout_msg]).map do |s, c|
30:      if s.key == c.session
31:        [c.client, c.server, s.key, s.value]
32:      end
33:    end
34:  end
\end{verbatim}
\vspace{-10pt}
\caption{Destructive cart implementation.}
\label{fig:pdg-destructive}
\vspace{-2pt}
\end{scriptsize}
\end{figure}