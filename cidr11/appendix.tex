\section{Networking Libraries}
\label{app:network-code}

\begin{figure}[t]
\begin{scriptsize}
\begin{lstlisting}
module DeliveryProtocol
  def state
    interface input, :pipe_in,
      ['dst', 'src', 'ident'], ['payload']
    interface output, :pipe_out,
      ['dst', 'src', 'ident'], ['payload']
 end
end

module BestEffortDelivery
  include DeliveryProtocol

  def state
    channel :pipe_chan,
      ['@dst', 'src', 'ident'], ['payload']
  end

  def initialize(host, port, opts)
    @addy = "#{host}:#{port}"
 end

  declare
  def snd
    pipe_chan <~ pipe_in
  end

  declare
  def done
    pipe_out <= pipe_in
  end
end

module ReliableDelivery
  include  BestEffortDelivery

  def state
    table :send_buf, ['dst', 'src', 'ident'], ['payload']
    channel :ack, ['@src', 'dst', 'ident']
    periodic :retry, 10
  end

  declare
  def remember
    send_buf <= pipe_in
    pipe_chan <~ join([send_buf, retry]).map{|p, t| p }
  end

  declare
  def done
    ack <~ pipe_chan.map{|p| [p.src, p.dst, p.ident]}
    send_done = join [ack, send_buf], [ack.ident, send_buf.ident]
    pipe_out <= send_done.map{|a, sb| sb}
    send_buf <- send_done.map{|a, sb| sb}
  end
end
\end{lstlisting}
\centering
\vspace{-10pt}
\caption{Delivery modules.}
\label{fig:delivery-impl}
\end{scriptsize}
\vspace{-2pt}
\end{figure}


\begin{figure}[t]
\begin{scriptsize}
\begin{lstlisting}
module MulticastProtocol
  def state
    table :members, ['peer']
    interface input, :send_mcast, ['ident'], ['payload']
    interface output, :mcast_done, ['ident'], ['payload']
  end
end

module Multicast
  include MulticastProtocol
  include DeliveryProtocol

  declare
  def snd_mcast
    pipe_in <= join([send_mcast, members]).map do |s, m|
      [m.peer, @addy, s.ident, s.payload]
    end
  end

  declare
  def done_mcast
    # override me
    mcast_done <= pipe_out.map{|p| [p.ident, p.payload]}
  end
end
\end{lstlisting}
\centering
%%\includegraphics[width=0.55\linewidth]{fig/basickvs.pdf}
\vspace{-10pt}
\caption{Multicast modules.}
\label{fig:multicast-impl}
\end{scriptsize}
\vspace{-2pt}
\end{figure}
