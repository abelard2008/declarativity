\section{Evaluation models}

Consider the \emph{successor} relation described above.  According to our intuitive interpretation, this relation models
the passage of time, in order to establish a temporal order among ground atoms.  \wrm{we're ignoring entanglement here} Two properties we expect of {\em successor} are:

\begin{itemize}

\item $\forall A,B \in \mathbb{Z} : successor(A, B) \Rightarrow B > A$ (i.e. whenever $successor(A,B)$ is true, then $B > A$)

\item $\forall A \in \mathbb{Z} : \exists! B \in \mathbb{Z} : successor(A,B)$ (i.e. every integer has a successor)

\end{itemize}

\wrm{we'd expect a lot more properties of successor than the ones you mentioned.  so instead of trying to think of them all, i just narrowed down what you wrote.}

This implies that successor is infinite (as we'd expect time to be), and is problematic because it leads to unsafe programs.

\newtheorem{example}{Example}
\begin{example}
Consider the Dedalus program and EDB below.  \wrm{move EDB definition before this?}

\begin{Dedalus}
r1
p_pos(A, B)@next \(\leftarrow\)
  p_pos(A, B),
  \(\lnot\)p_neg(A, B);
  
p_pos(A, B)  \(\leftarrow\)
  p(A, B);
  
p(1, 2)@123;
  
\end{Dedalus}

The single ground fact will, due to \emph{r1}, cause as many deductions as there are tuples in the \emph{successor} relation.
Clearly, if the relation is infinite this program in unsafe.

\end{example}

But if \emph{successor} is infinite, many of these deductions may be \emph{void}in some sense, i.e. functionally determined based on the EDB. \wrm{is functionally determined a real term?}
In effect, an EDB that is given in its totality determines a window over successor that is relevant to any computation that must be performed.  \wrm{what about NDB?}
It is easy to see that in this example, we need only consider a successor relation that contains a single tuple \{123, 124\}.

Consider the given EDB extended with two more facts:

\begin{Dedalus}
delete p(1, 2)@456;
p(?, ?)@789;
\end{Dedalus}

Evaluating this program and EDB will require a \emph{successor} relation with values that range from 123 - 789.

\begin{definition}
A \emph{post-hoc} evaluation is an evaluation of a Dedalus program in which an EDB is given, and \emph{successor} is derived from it
as part of a fixpoint computation.
\end{definition}

In a post-hoc evaluation, we may use the given EDB to populate the successor relation in the following way.
Define first a second order predicate called \emph{event\_time}
that contains the union of the time attributes from the EDB prefix. Let \emph{Trace} be the set of $n$ EDB predicates.  
Then \emph{event\_time} is defined as

$event\_time(\Tau) \leftarrow \displaystyle\bigcup_{i}^n \pi_{\Tau}Trace_{i}$

We populate \emph{successor} with a negation-free Datalog program with arithmetic and aggregate functions, as shown below.

\begin{Dedalus}
smax(max<N>) \(\leftarrow\) event\_time(N);
smin(min<N>) \(\leftarrow\) event\_time(N);

successor(N, N + 1) \(\leftarrow\) smin(N);

successor(S, S + 1) \(\leftarrow\) 
    successor(N, S),
    smax(M),
    N <= M;
\end{Dedalus}

In a post-hoc evaluation, time is in some sense ``instantaneous" in that all values of the successor relation are considered in a single
fixpoint computation.  The complete program is safe if the EDB is finite.

\subsection{EDB Prefixes}
\paa{notes follow}

In general, however, an EDB can itself be infinite, and will lead to unsafe evaluations even when \emph{successor} is derived from it
as in a post-hoc evaluation.

\begin{definition}
A \emph{prefix} $\alpha_{n}$ of an EDB $\Gamma$ is the set of facts in $\Gamma$ whose timestamp is greater than or equal to $n$. \wrm{less than or equal to.}
\end{definition}

If the EDB is finite, then it has a maximum timestamp $\top$, and $\alpha_{\top}$ = $\Gamma$.  Because each prefix is a superset of all 
prefixes with lower indices, we also have the monotonicity property

\begin{equation}
\forall \alpha_{i}, \alpha_{j} \in \Gamma ((i < j) \to (\alpha_{i} \subseteq \alpha_{j}))
\end{equation}

paa{to your point, bill, I switched the lemma and proof below to one of IDB equivalence in the posthoc vs. continual interpretation
rather than an inductive proof that every model in the series is minimal.  there is probably a very similar proof of the latter
that we could include in the next section after introducing minimal models, stratification etc}


\newtheorem{lemma}{Lemma} 
\begin{lemma}

Consider a function $FP$ from $Program, EDB \mapsto IDB$ that represents the \emph{fixpoint} computation carried out by a datalog interpreter,
a program $P$, EDB $\Gamma$, and a set $\Lambda$ of indices into the prefixes $\alpha_{n}$ of $\Gamma$.


\begin{equation}
\forall k \in \Lambda (FP(P, \alpha_{k}) =  \displaystyle \bigcup_{i=0}^{k} FP(P, \alpha_{i}))
\end{equation}
\end{lemma}
%%for any $k$. 

%%this could (with some work) lead to an inductive proof
%%that an infinite model is minimal.  we could prove the (weaker?) property that
%%the infinite series of models of increasing finite prefixes of an EDB are all 
%%minimal if one of them is.

\begin{proof}

%%Inductive step:

%%if we assume that some program P and finite prefix $\alpha_n$ of a trace $\Gamma$ produce a minimal model, 
%%then it follows that a prefix $\alpha_{n+1}$ and the IDB produced by the previous model produce a minimal model.

Assume the contrary, that there is some program P, prefix $\alpha_i$ and prefix $\alpha_j$  such that:

%%$\alpha_j$ follows $\alpha_i$, 
$i < j$

$I_1 = FP(\alpha_i)$

$I_2 = FP(\alpha_j \cup I_1)$

$I_3 = FP(\alpha_j)$

$I_2 \neq I_3$


If $I_2 \neq I_3$, it must be the case that either there exists a ground atom in $I_2$ that is not in $I_3$, or that is in
$I_3$ and not in $I_2$.  

Take the former case first.  This means there is an atom $A$ that is entailed by P given $FP(\alpha_{j} \cup FP(\alpha_{i}))$
but not entailed by P given $\alpha_{j}$, so it must be in $I_1$.   The only circumstances under which an atom in some
$I_1$ would not occur in the IDB $FP(\alpha{j})$ with $I_1 \subseteq \alpha_{j}$ is if there is a fact $B$ in $\alpha_{j}$ 
corresponding to a negated subgoal in a rule $r$ in P upon which A depends.  However, for this to occur, because a ground atom 
in $I_1$ cannot depend upon a ground atom from the ``future", that fact $B$ would need to have occurred at some time less than 
or equal to the to timestamp of atom $A$.  But this is not possible, because all timestamps in $\alpha_{j}$ that are not in any $\alpha_{k} | k<j$
are strictly higher than any timestamps in $\alpha_{k}$.  Hence the first case leads to contradiction.

As for the second case...

\end{proof}

\textbf{Old proof} (to be removed):
\begin{proof}
then in $I_2$ there exists a ground atom that is not in $\alpha_j$ 
\wrm{don't get this.  do you think we should define minimal model and fixpoint before this?}  
(and hence not in $\alpha_i$), and is not entailed by P given $\alpha_j$.  
such a ground atom must then either be:

\begin{enumerate}
\item contained in $I_1$, hence entailed by P given $\alpha_i$.
\item entailed by P given some IDB atom in $I_1$.
\end{enumerate}

In the first case, in principle is it possible for an atom X to exist in $I_1$ and not in $I_2$, if for example it depended negatively via a 
rule r on a predicate q, and a q fact (Y) exists in  $\alpha_j$ that didn't exist in  $\alpha_i$.  However, for this to occur, because a ground atom 
in I1 cannot depend upon a ground atom from the "future", that event q would need to have occurred at some time less than 
or equal to the to timestamp of atom X.  but this is not possible, because our trace is ordered in timestamp order.  hence the 
first case leads to contradiction.

in the second case, there is some ground atom Y in I1 upon which X depends.  Y is not in FP( $\alpha_j$), because if it were, X would 
be part of the single minimal model.  if Y is not in FP( $\alpha_j$), it too is not part of a minimal model for P given  $\alpha_j$!  if it is in the minimal 
model for FP($\alpha_i$) but not FP( $\alpha_j$), there must be a fact in  $\alpha_j$ upon which an atom in FP($\alpha_i$) depended negatively.  by the same 
argument as above, such a fact could not be in  $\alpha_j$, because new facts in  $\alpha_j$ have timestamps strictly higher than those in  $\alpha_i$.
\end{proof}


